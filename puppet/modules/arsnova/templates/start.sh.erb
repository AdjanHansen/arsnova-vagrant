#!/usr/bin/env bash

echo -e "Starting ARSnova. This could take a few seconds...\c"

OUTPUT_REDIRECT="2>/dev/null 1>&2"
VERBOSE=""
while getopts v opt
do
  case $opt in
    v)
      OUTPUT_REDIRECT=""
      VERBOSE="-v"
      ;;
  esac
done
shift $((OPTIND - 1))

CWD=`pwd`
ARSNOVA_SERVER="<%= @server_path %>"
ARSNOVA_MOBILE="<%= @mobile_path %>"

PID_FILE_MOBILE="<%= @mobile_pid %>"
PID_FILE_SERVER="<%= @server_pid %>"

eval "./stop.sh $VERBOSE $OUTPUT_REDIRECT"

PID_MOBILE=0
PID_SERVER=0

cd "$ARSNOVA_MOBILE"
eval "ant -quiet sencha:app:watch -e <%= @sencha_env %> $OUTPUT_REDIRECT &"
PID_MOBILE=$!

cd "$ARSNOVA_SERVER"
eval "mvn -q jetty:run -Dmobile.path=<%= @mobile_target %> $OUTPUT_REDIRECT &"
PID_SERVER=$!

cd "$CWD"

echo "$PID_MOBILE" > "$PID_FILE_MOBILE"
echo "$PID_SERVER" > "$PID_FILE_SERVER"

RESPONSE_CODE=0
while [ "$RESPONSE_CODE" -ne 200 ]
do
  # courtesy of http://superuser.com/a/442395
  RESPONSE_CODE=`curl -s -o /dev/null -I -w "%{http_code}" -m 5 http://localhost:8080/index.html`
  sleep 5
  echo -e ".\c"
done

echo -e "\nARSnova is now ready @ http://localhost:8080/index.html"
